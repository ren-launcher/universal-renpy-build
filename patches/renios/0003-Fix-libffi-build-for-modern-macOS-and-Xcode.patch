From 8f8426325065830fac0eca9521a0b2b718959d5e Mon Sep 17 00:00:00 2001
From: cnfatal <cnfatal@gmail.com>
Date: Tue, 17 Feb 2026 00:30:51 +0800
Subject: [PATCH 3/8] Fix libffi build for modern macOS and Xcode

- Replace /usr/bin/python with python3 in Xcode project (removed in macOS 12.3+)
- Raise IPHONEOS_DEPLOYMENT_TARGET from 5.0 to 12.0 (minimum for modern SDK)
---
 dependencies/scripts/build-libffi.sh | 13 +++++++++++++
 1 file changed, 13 insertions(+)

diff --git a/dependencies/scripts/build-libffi.sh b/dependencies/scripts/build-libffi.sh
index 5f8a7fc..22bcb8b 100755
--- a/dependencies/scripts/build-libffi.sh
+++ b/dependencies/scripts/build-libffi.sh
@@ -28,6 +28,19 @@ pushd $TMPROOT/libffi-$FFI_VERSION
 
 # libffi needs to use "-miphoneos-version-min=6.0" for xcode 6+ to compile it correctly
 sed -i.bak s/-miphoneos-version-min=5.1.1/-miphoneos-version-min=6.0/g generate-darwin-source-and-headers.py
+# Fix /usr/bin/python (removed in modern macOS) -> use PATH python (deps)
+sed -i.bak 's|/usr/bin/python |python |g' libffi.xcodeproj/project.pbxproj
+# Fix deployment target for modern SDK (minimum 12.0 required)
+sed -i.bak 's/IPHONEOS_DEPLOYMENT_TARGET = 5.0/IPHONEOS_DEPLOYMENT_TARGET = 12.0/g' libffi.xcodeproj/project.pbxproj
+# Remove i386/armv7 configure targets from generate script (unsupported in modern Xcode)
+# Keep copy_src_platform_files and make_tramp since Xcode project references those source files
+sed -i.bak '/build_target(simulator_platform,/d; /build_target(device_platform[^6]/d' generate-darwin-source-and-headers.py
+# Fix aarch64 assembly: swap .cfi_startproc and CNAME label order
+# (Xcode 15+ rejects non-private labels between .cfi_startproc/.cfi_endproc)
+perl -0777 -pi -e 's/([ \t]+\.cfi_startproc)\n(CNAME\([^)]+\):)/$2\n$1/g' src/aarch64/sysv.S
+# Pre-generate source files before xcodebuild to avoid race condition with
+# Xcode's parallel build system (Run Script phase has no declared outputs)
+python generate-darwin-source-and-headers.py --only-ios
 try xcodebuild -project libffi.xcodeproj -target "libffi-iOS" -configuration $RENIOSBUILDCONFIGURATION -sdk $SDKROOT -arch $RENIOSARCH clean
 try xcodebuild -project libffi.xcodeproj -target "libffi-iOS" -configuration $RENIOSBUILDCONFIGURATION -sdk $SDKROOT -arch $RENIOSARCH
 
-- 
2.52.0

