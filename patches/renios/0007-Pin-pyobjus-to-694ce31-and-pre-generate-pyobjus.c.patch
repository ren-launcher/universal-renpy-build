From 4af686967e03ce24482d1510887140ab1da8df45 Mon Sep 17 00:00:00 2001
From: cnfatal <cnfatal@gmail.com>
Date: Tue, 17 Feb 2026 03:15:36 +0800
Subject: [PATCH 7/8] Pin pyobjus to 694ce31 and pre-generate pyobjus.c for iOS

Pin to commit 694ce31 (last Python 2 compatible commit).

The iOS code path in setup.py expects a pre-generated pyobjus.c
(files = ['pyobjus.c']), but this file was never committed to
the pyobjus git repo. pyobjus.pyx includes config.pxi which
defines compile-time constants PLATFORM and ARCH; setup.py
normally generates config.pxi at runtime, but the iOS path
skips Cython entirely and uses the pre-built .c file.

Pre-generate config.pxi and pyobjus.c using the deps Cython
CLI binary before the cross-compile step, so hostpython (which
lacks Cython) can build from the .c source directly.

On arm64, objc_msgSend_stret is unavailable (struct returns use
objc_msgSend directly). Replace references in generated C source
files before compilation via sed.
---
 dependencies/scripts/build-pyobjus.sh | 27 ++++++++++++++++++++++++++-
 1 file changed, 26 insertions(+), 1 deletion(-)

diff --git a/dependencies/scripts/build-pyobjus.sh b/dependencies/scripts/build-pyobjus.sh
index 0731f90..00a99d9 100755
--- a/dependencies/scripts/build-pyobjus.sh
+++ b/dependencies/scripts/build-pyobjus.sh
@@ -4,12 +4,29 @@
 
 
 
+# Pin to 694ce31 - last Python 2 compatible commit (supports Python 2.7/3.5-3.7)
+PYOBJUS_COMMIT=694ce31
+
 if [ ! -d $TMPROOT/pyobjus ] ; then
-    git clone https://github.com/kivy/pyobjus.git $TMPROOT/pyobjus
+    try git clone https://github.com/kivy/pyobjus.git $TMPROOT/pyobjus && git -C $TMPROOT/pyobjus checkout -f $PYOBJUS_COMMIT
 fi
 
 try pushd $TMPROOT/pyobjus
 
+# The iOS path in setup.py uses files=['pyobjus.c'] (pre-generated C source),
+# but pyobjus.c was never shipped in the git repo. Pre-generate it here.
+# pyobjus.pyx includes config.pxi for compile-time PLATFORM/ARCH constants;
+# setup.py normally generates config.pxi, but we must create it before cython.
+if [ -f pyobjus/pyobjus.pyx ] && [ ! -f pyobjus/pyobjus.c ]; then
+    echo "Pre-generating pyobjus.c from pyobjus.pyx using deps cython..."
+    printf 'DEF PLATFORM = "ios"\nDEF ARCH = "%s"' "$RENIOSARCH" > pyobjus/config.pxi
+    if [ -n "$RENPY_DEPS_INSTALL" ] && [ -x "$RENPY_DEPS_INSTALL/bin/cython" ]; then
+        try "$RENPY_DEPS_INSTALL/bin/cython" pyobjus/pyobjus.pyx
+    else
+        try cython pyobjus/pyobjus.pyx
+    fi
+fi
+
 # Set environment variables for Python module cross-compile
 OLD_CC="$CC"
 OLD_CFLAGS="$CFLAGS"
@@ -17,6 +34,13 @@ OLD_LDSHARED="$LDSHARED"
 export CC="$ARM_CC"
 export CFLAGS="$ARM_CFLAGS"
 export CFLAGS="$CFLAGS -I$BUILDROOT/include -I$BUILDROOT/include/ffi"
+# On arm64, objc_msgSend_stret is unavailable (struct returns use objc_msgSend).
+# Replace references in generated source files before compilation.
+if [ "$RENIOSARCH" = "arm64" ]; then
+    for f in pyobjus/pyobjus.c pyobjus/_runtime.h; do
+        [ -f "$f" ] && sed -i '' 's/objc_msgSend_stret/objc_msgSend/g' "$f"
+    done
+fi
 export LDSHARED="$RENIOSDEPROOT/scripts/liblink"
 
 HOSTPYTHON="$RENIOSDEPROOT/tmp/Python-$PYTHON_VERSION/hostpython"
@@ -47,4 +71,3 @@ export CFLAGS="$OLD_CFLAGS"
 export LDSHARED="$OLD_LDSHARED"
 
 popd
-
-- 
2.52.0
