From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: cnfatal <cnfatal@gmail.com>
Date: Mon, 17 Feb 2026 12:00:00 +0800
Subject: [PATCH 3/3] Add DT_SONAME to libpymodules.so for dlopen compatibility

biglink.py creates libpymodules.so with -shared but without -soname,
so the resulting .so has no DT_SONAME entry. This causes dlopen() by
bare name ("libpymodules.so") to fail when the library was loaded via
System.loadLibrary() from a non-standard path (e.g. DFM SplitCompat
directory), because the linker registers it by its absolute path
instead of the short soname.

Add -Wl,-soname,<basename> to the biglink linker invocation so that
the dynamic linker can match subsequent dlopen() calls to the already
loaded library.
---
 native/scripts/biglink.py | 4 +++-
 1 file changed, 3 insertions(+), 1 deletion(-)

diff --git a/native/scripts/biglink.py b/native/scripts/biglink.py
old mode 100755
new mode 100755
index 1234567..abcdefg
--- a/native/scripts/biglink.py
+++ b/native/scripts/biglink.py
@@ -41,7 +41,9 @@ while args:
 
 print('Biglink create %s library' % sys.argv[1])
 
-args = os.environ['LD'].split() + os.environ["LDFLAGS"].split() + [ '-Wl,-Bsymbolic', '-shared', '-O3', '-o', sys.argv[1] ] + unique_args
+output_soname = os.path.basename(sys.argv[1])
+
+args = os.environ['LD'].split() + os.environ["LDFLAGS"].split() + [ '-Wl,-Bsymbolic', '-shared', '-O3', '-Wl,-soname,' + output_soname, '-o', sys.argv[1] ] + unique_args
 
 for i in args:
     print(i)
-- 
2.39.0

