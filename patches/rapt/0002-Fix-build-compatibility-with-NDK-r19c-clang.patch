From 09d41099f1550ffec8777bcb158a8adf53c08968 Mon Sep 17 00:00:00 2001
From: cnfatal <cnfatal@gmail.com>
Date: Mon, 16 Feb 2026 01:24:12 +0800
Subject: [PATCH 2/3] Fix build compatibility with NDK r19c clang

- build.sh: change armeabi-v7a OpenSSL target from 'android' to
  'linux-generic32' to avoid unsupported -mandroid flag in clang
- openssl.sh: specify MAKEDEPPROG in make depend to bypass ccache
  not recognizing -D option
- liblink.py: skip -Wl, prefixed linker flags instead of erroring
---
 native/build.sh           | 2 +-
 native/scripts/liblink.py | 3 +++
 native/scripts/openssl.sh | 2 +-
 3 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/native/build.sh b/native/build.sh
index be36040..236a1cc 100755
--- a/native/build.sh
+++ b/native/build.sh
@@ -82,7 +82,7 @@ build_arm () {
     export GCC_ARCH=arm-linux-androideabi
 
     # The arch arguments provided to openssl.
-    export OPENSSL_ARCH="android -march=armv7-a"
+    export OPENSSL_ARCH="linux-generic32 -march=armv7-a"
 
     # The -fPIC flag, if needed.
     export PICFLAG=""
diff --git a/native/scripts/liblink.py b/native/scripts/liblink.py
index 37a6bd2..860acc0 100755
--- a/native/scripts/liblink.py
+++ b/native/scripts/liblink.py
@@ -49,6 +49,9 @@ while i < len(sys.argv):
     if opt.startswith("-D"):
         continue
 
+    if opt.startswith("-Wl,"):
+        continue
+
     if opt.startswith("-"):
         print(sys.argv)
         print("Unknown option: %s" % opt)
diff --git a/native/scripts/openssl.sh b/native/scripts/openssl.sh
index f2c46f6..e769c77 100644
--- a/native/scripts/openssl.sh
+++ b/native/scripts/openssl.sh
@@ -18,7 +18,7 @@ build () {
         no-asm no-shared no-comp no-hw no-engine \
         $OPENSSL_ARCH -fPIC -D__ANDROID_API__=${ANDROID_PLATFORM#android-}
 
-    make depend CFLAGS="$CFLAGS"
+    make depend MAKEDEPPROG="$GCC_ARCH-gcc -isysroot $INSTALLDIR/toolchain/sysroot" CFLAGS="$CFLAGS"
     make
     make install
 
-- 
2.34.1

