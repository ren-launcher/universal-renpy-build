From f1a8af9a8555ffef7796111694123f8357a31f5f Mon Sep 17 00:00:00 2001
From: fatalc <cnfatal@gmail.com>
Date: Tue, 17 Feb 2026 00:14:49 +0800
Subject: [PATCH] Fix macOS modern SDK and toolchain compatibility

- build_mac.sh: Raise MACOSX_DEPLOYMENT_TARGET from 10.6 to 10.9
  (modern SDL2 requires >= 10.7)
- build_mac.sh: Set PKG_CONFIG_PATH to prefer our own built deps
  over Homebrew system libraries
- build.sh: Replace freetype patch command with sed (patch context
  mismatch between 2.2.1 patch and 2.4.11 source)
- build.sh: Fix libpng-1.2.49 fp.h -> math.h for modern macOS SDK
  (Carbon fp.h removed)
- build.sh: Remove AGL framework from GLEW (removed in macOS 10.15+)
- build.sh: Add strings.h include to zsync http.c for strcasecmp
  (modern clang C99+ strictness)
---
 build.sh     | 20 +++++++++++++++++++-
 build_mac.sh |  5 ++++-
 2 files changed, 23 insertions(+), 2 deletions(-)

diff --git a/build.sh b/build.sh
index 8dba52a..22326f0 100755
--- a/build.sh
+++ b/build.sh
@@ -200,7 +200,7 @@ if [ \! -e built.freetype ]; then
    try tar xjf "$SOURCE/freetype-2.4.11.tar.bz2"
    try cd "$BUILD/freetype-2.4.11"
 
-   try patch -p1 < "$SOURCE/freetype-2.2.1-enable-valid.patch"
+   sed -i "" "s/^# AUX_MODULES += gxvalid/AUX_MODULES += gxvalid/" modules.cfg && sed -i "" "s/^# AUX_MODULES += otvalid/AUX_MODULES += otvalid/" modules.cfg
 
    try ./configure --prefix="$INSTALL"
 
@@ -242,6 +242,13 @@ if [ \! -e built.png ]; then
 
    try tar xvzf "$SOURCE/libpng-1.2.49.tar.gz"
    try cd "$BUILD/libpng-1.2.49"
+
+   if [ $PLATFORM = "mac" ]; then
+       # Modern macOS SDK no longer ships <fp.h> (Carbon era).
+       # Replace fp.h with math.h which provides the same math functions.
+       sed -i "" 's/#      include <fp.h>/#      include <math.h>/' pngconf.h
+   fi
+
    try ./configure --prefix="$INSTALL" --enable-shared --disable-static
    try make
    try make install
@@ -529,6 +536,11 @@ if [ \! -e built.glew -a -z "$RASPBERRY_PI" ]; then
    try tar xzf "$SOURCE/glew-1.7.0.tgz"
    try cd "$BUILD/glew-1.7.0"
 
+   if [ $PLATFORM = "mac" ]; then
+       # Modern macOS SDK removed AGL framework; use OpenGL only.
+       sed -i "" 's/-framework AGL -framework OpenGL/-framework OpenGL/' config/Makefile.darwin
+   fi
+
    try make install OPT="$CFLAGS $LDFLAGS" CC="$CC" LD="$LD" GLEW_DEST=$INSTALL
 
    cd "$BUILD"
@@ -544,6 +556,12 @@ if [ $PLATFORM != "windows" ] ; then
     try patch -p1 < "$SOURCE/zsync-no-isastty.diff"
     try patch -p0 < "$SOURCE/zsync-compress-5.diff"
 
+    # Fix implicit function declarations (modern clang C99+ strictness)
+    if [ $PLATFORM = "mac" ]; then
+        sed -i "" '1i\
+#include <strings.h>' http.c
+    fi
+
     try "./configure" --prefix="$INSTALL"
     try make
     try make install
diff --git a/build_mac.sh b/build_mac.sh
index a4b06b6..659fc1a 100755
--- a/build_mac.sh
+++ b/build_mac.sh
@@ -11,7 +11,7 @@ DIR=`dirname $0`
 # Note - I had to link this into the SDKs directory of XCode to make it work.
 # I'm not sure why.
 # export SDKROOT="/Users/tom/SDKs/MacOSX10.6.sdk"
-export MACOSX_DEPLOYMENT_TARGET=10.6
+export MACOSX_DEPLOYMENT_TARGET=10.9
 
 export PATH="$SDKROOT/usr/bin:$PATH"
 
@@ -23,5 +23,8 @@ export LDFLAGS="-mmacosx-version-min=$MACOSX_DEPLOYMENT_TARGET"
 
 export JPEG_ASM="--host x86_64-apple-darwin"
 
+# Ensure our own built deps are found before Homebrew's
+export PKG_CONFIG_PATH="$PWD/install/lib/pkgconfig"
+
 try "$DIR/build_python.sh"
 try "$DIR/build.sh"
-- 
2.50.1 (Apple Git-155)

